{{- define "body" -}}

{{ $revealjsVersion := "5.1.0" }}
{{ $revealjsBaseURL := printf "https://cdnjs.cloudflare.com/ajax/libs/reveal.js/%s" $revealjsVersion }}

<body>
  {{- $content := .Content }}

  {{/*
    Preprocessing:
    Cleanup and transform Markdown content to be compatible with Reveal.js structure.
  */}}

  <!-- Remove the <hr /> tag generated by blackfriday for footnotes to avoid breaking slide structure -->
  {{- $content := replace .Content "<div class=\"footnotes\">\n\n <hr />" "<div class=\"footnotes\">" -}}

  <!--
    Highlight.js Integration:
    Reveal.js has its own highlighting. We need to disable Hugo's default syntax highlighting
    processing for code blocks to let Reveal.js handle it, or pass parameters through.
  -->
  <!-- Disable Hugo highlighting: change class to "nohighlight" and add "data-noescape" -->
  {{- $content := replaceRE `<code class="language-\w+" \s+data-lang="\w+" ` `<code class="nohighlight" data-noescape` $content -}}

  <!-- Enable Line Numbers: Convert ```js{} to data-line-numbers -->
  {{- $content := replaceRE `(<code class="language-\w+){}(">)` `$1" data-line-numbers>` $content -}}

  <!-- Enable Line Highlights: Convert ```js{1,5-7} to data-line-numbers="1,5-7" -->
  {{- $content := replaceRE `(<code class="language-\w+){(\S+)}(">)` `$1" data-line-numbers="$2">` $content -}}

  <!-- Normalize HR tags: Support both <hr /> (blackfriday) and <hr> (mmark) for slide separation -->
  {{- $content := replace $content " <hr>" " <hr />" -}}

  <!-- Auto-Animate: Replace %auto-animate% magic string with script to set attribute on parent slide -->
  {{- $content := replace $content "<p>%auto-animate%</p>" " <script>document.currentScript.parentNode.setAttribute('data-auto-animate', '1');</script>" -}}

  <div class="reveal">
    <div class="slides">
      <!-- Split the processed content by <hr /> tag to create individual slides -->
      {{- range (split $content "<hr>") -}}
      <section>
        {{- . | safeHTML -}}
      </section>
      {{- end -}}
    </div>
  </div>

  {{ with .Params.logo }}

  <style>
    #logo {
      position: absolute;
      top: 20px;
      left: 20px;
      width: 250px;
      max-width: 2rem;
      max-height: 2rem;
    }
  </style>

  <img id="logo" src="{{ . }}" alt="logo">

  {{ end }}

  {{ with resources.GetRemote (printf "%s/reveal.js" $revealjsBaseURL) | fingerprint }}
  <script src="{{ .RelPermalink }}" integrity="{{ .Data.Integrity }}" crossorigin="anonymous"></script>
  {{ end }}

  {{ with resources.GetRemote (printf "%s/plugin/zoom/zoom.min.js" $revealjsBaseURL) | fingerprint }}
  <script src="{{ .RelPermalink }}" integrity="{{ .Data.Integrity }}" crossorigin="anonymous"></script>
  {{ end }}

  {{ with resources.GetRemote (printf "%s/plugin/math/math.min.js" $revealjsBaseURL) | fingerprint }}
  <script src="{{ .RelPermalink }}" integrity="{{ .Data.Integrity }}" crossorigin="anonymous"></script>
  {{ end }}

  {{ with resources.GetRemote (printf "%s/reset.min.css" $revealjsBaseURL) | fingerprint }}
  <link rel="stylesheet" href="{{ .RelPermalink }}" integrity="{{ .Data.Integrity }}" crossorigin="anonymous"></link>
  {{ end }}

  {{ with resources.GetRemote (printf "%s/reveal.min.css" $revealjsBaseURL) | fingerprint }}
  <link rel="stylesheet" href="{{ .RelPermalink }}" integrity="{{ .Data.Integrity }}" crossorigin="anonymous"></link>
  {{ end }}

  {{ with resources.GetRemote (printf "%s/theme/black.min.css" $revealjsBaseURL) | fingerprint }}
  <link rel="stylesheet" href="{{ .RelPermalink }}" integrity="{{ .Data.Integrity }}" crossorigin="anonymous"></link>
  {{ end }}

  <script>
    Reveal.on('ready', () => {
      console.log('RevealJS iniciado')
    })
    Reveal.initialize({
      plugins: [
        RevealMath.KaTeX
      ]
    })
  </script>

</body>
{{- end -}}

{{- define "head" -}}
{{- end -}}
